# üöÄ Ansible deploy project for ARSP

–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ARSP –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö Astra-linux

# –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π

``` bash
git clone https://github.com/holyblaz/ansible_deploy.git
cd –≤–∞—à —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π/ansible
``` 

### 1. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. **–ù–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π –Ω–æ–¥–µ**
    - Ubuntu 
    - Ansible >= 2.12
    - SSH-–∫–ª–∏–µ–Ω—Ç –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π –Ω–æ–¥–µ

2. **–ù–∞ —É–ø—Ä–∞–≤–ª—è–µ–º—ã—Ö –Ω–æ–¥–∞—Ö**
    - [Python 3.5+]
    - SSH-–¥–æ—Å—Ç—É–ø –∫ —Ü–µ–ª–µ–≤—ã–º —Å–µ—Ä–≤–µ—Ä–∞–º
    - –ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `sysadm` (—É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ /var/main.yml)
    - –ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è SSH (—É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ /var/main.yml)

### 2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:

```bash
deploy_project/
‚îú‚îÄ‚îÄ deploy.yml                        # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—Ä—É–∞—Ü–∏–æ–Ω–Ω—ã–π .yml playbook
‚îú‚îÄ‚îÄ files                             # –§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
‚îÇ   ‚îú‚îÄ‚îÄ arsp_new_XX_XX_XX.zip         # –ê—Ä—Ö–∏–≤ —Å –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–µ–π –ø—Ä–æ–µ–∫—Ç–∞
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ add_migrations.py             # –°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π 
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ pg_backup.sh                  # –°–∫—Ä–∏–ø—Ç –¥–ª—è –±–µ–∫–∞–ø–∞ –ë–î
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ project_copy.sh               # –°–∫—Ä–∏–ø—Ç –¥–ª—è –±–µ–∫–∞–ø–∞ –ø—Ä–æ–µ–∫—Ç–∞ 
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ python_scripts                # –°–∫—Ä–∏–ø—Ç—ã –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –æ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ redeploy_no_db_no_compile.sh  # –°–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–µ–∑ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –∏ –ë–î
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ write_showmigrations_info.py  # –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–∏–≥—Ä–∞—Ü–∏–π 
‚îú‚îÄ‚îÄ inventory
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ hosts.yml                     # –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å —Ö–æ—Å—Ç–æ–≤ (—Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤)
‚îú‚îÄ‚îÄ README.md                         
‚îú‚îÄ‚îÄ templates
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ telegram.j2
‚îî‚îÄ‚îÄ vars                              
    ‚îî‚îÄ‚îÄ main.yml                      # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```

ansible-playbook/
‚îú‚îÄ‚îÄ files/                            # üìÅ –§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ã
‚îÇ   ‚îú‚îÄ‚îÄ arsp_new.zip                  # üì¶ –ê—Ä—Ö–∏–≤ —Å –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–µ–π –ø—Ä–æ–µ–∫—Ç–∞ (zip-—Ñ–∞–π–ª)
‚îÇ   ‚îú‚îÄ‚îÄ redeploy_no_db_no_compile.sh  # üõ† –°–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–µ–∑ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –∏ –ë–î
‚îÇ   ‚îú‚îÄ‚îÄ add_migrations.py             # üêç Python-—Å–∫—Ä–∏–ø—Ç –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ show_migrations.py            # üìã Python-—Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–∏–≥—Ä–∞—Ü–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ project_copy.sh               # üìÑ Bash-—Å–∫—Ä–∏–ø—Ç –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞
‚îÇ   ‚îî‚îÄ‚îÄ pg_backup.sh                  # üíæ Bash-—Å–∫—Ä–∏–ø—Ç –¥–ª—è –±—ç–∫–∞–ø–∞ PostgreSQL
‚îú‚îÄ‚îÄ inventory/
‚îÇ   ‚îî‚îÄ‚îÄ hosts.yml                     # üåê –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å —Ö–æ—Å—Ç–æ–≤ (—Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤)
‚îú‚îÄ‚îÄ vars/
‚îÇ   ‚îî‚îÄ‚îÄ main.yml                      # üîß –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è: Telegram, –ø—Ä–æ–µ–∫—Ç, —Ç.–¥.
‚îú‚îÄ‚îÄ deploy.yml                        # üöÄ –û—Å–Ω–æ–≤–Ω–æ–π Ansible –ø–ª–µ–π–±—É–∫

### 3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª `inventory\hosts.yml`:
```yaml
all:
  children:
    test_servers:   # –†–∞–±–æ—á–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ –≤—Å–µ–π –∫–æ–º–∞–Ω–¥—ã
      hosts:
        server1:
          ansible_host: 172.29.12.225
        server2:
          ansible_host: 172.29.12.231
        server3:
          ansible_host: 172.29.12.229
    hosts_for_developers:  # –†–∞–±–æ—á–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
      hosts:
        server4:
          ansible_host: 172.29.12.–•–•1 # –ü—Ä–∏–º–µ—Ä —Å–µ—Ä–≤–µ—Ä–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
        server5:
          ansible_host: 172.29.12.XX2

### X. YFncfdfd

| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `ansible-playbook -i hosts.yml deploy.yml --limit "test_servers"` | **–ó–∞–ø—É—Å–∫ –¥–µ–ø–ª–æ—è** –Ω–∞ –≤—Å–µ—Ö —Ä–∞–±–æ—á–∏—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö –∫–æ–º–∞–Ω–¥—ã |
| `ansible-playbook -i hosts.yml deploy.yml --limit "hosts_for_developers"` | **–ó–∞–ø—É—Å–∫ –¥–µ–ø–ª–æ—è** –Ω–∞ –≤—Å–µ—Ö —Ä–∞–±–æ—á–∏—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ |
| `ansible-playbook -i hosts.yml deploy.yml --limit "serverX"` | **–û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫—É** —Ç–æ–ª—å–∫–æ –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ |
| `ansible-playbook -i hosts.yml deploy.yml --limit "server1,server4,server5"` | **–û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫—É** —Ç–æ–ª—å–∫–æ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö |

### X. –ó–∞–ø—É—Å–∫ playbook

 # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –Ω–æ–¥
    ansible all -i inventory.yml -m ping

–ß—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –¥–µ–ø–ª–æ–π, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É:
    ansible-playbook -i inventory/hosts.yml deploy.yml # –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤, —É–∫–∞–∑–∞–Ω—ã—ã–∑ –≤ host.yml -> –≤ –≥—Ä—É–ø–ø–µ all

–ß—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Ö–æ—Å—Ç–∞—Ö:
    ansible-playbook -i inventory/hosts.yml deploy.yml --limit "server1,server2.." # –ó–∞–ø—É—Å–∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤, —É–∫–∞–∑–∞–Ω—ã—ã—Ö –≤ host.yml -> –≤ –≥—Ä—É–ø–ø–µ all 



***–ó–∞–ø—É—Å–∫ Ansible –Ω–∞ Windows***

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ WSL2:
    wsl --install -d Ubuntu

2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ Ubuntu –∏ –æ–±–Ω–æ–≤–∏—Ç–µ –ø–∞–∫–µ—Ç—ã:
    sudo apt update && sudo apt upgrade -y

3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Ansible:
    sudo apt install ansible -y

4. –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å Ansible —á–µ—Ä–µ–∑ WSL


***Docker (Ansible –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ)*** –¢–ï–°–¢–û–í–´–ô –í–ê–†–ò–ê–ù–¢

- docker run --rm -v ${PWD}:/ansible ansible/ansible:latest ansible playbook playbook.yml


